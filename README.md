# Socket编程
## 1. Socket基础
> 什么是具体的socket？
发送信息的应用程序，通过 `socket 编程接口` 把信息给操作系统的TCP/IP协议栈通讯模块；通讯模块一层层传递给 其他通讯模块（网卡驱动等），最后再通过网卡等硬件设备发送到网络上去；最后接收信息的程序，通过 `socket 编程接口` 接收到了 传输的信息。

![](./images/socket1.png)
> TCP协议中格式为什么一定要明确规定消息的格式？
定义的消息包括 消息头 和 消息体。

消息头存放消息的格式数据， 比如 消息的长度、类型、状态等等， 而消息体存放具体的传送数据。

对于使用TCP协议传输信息的程序来说，格式定义一定要明确规定 `消息的边界` 。

因为 TCP协议传输的是 `字节流（bytes stream）`， 如果消息中没有指定 边界 或者 长度，接收方就不知道一个完整的消息从字节流的 哪里开始，到 哪里结束。

指定消息的边界有两种方式：

- 用特殊字节作为消息的结尾符号

可以用消息内容中不可能出现的字节串 （比如 `FFFFFF`） 作为消息的结尾字符。

- 在消息开头某个位置，直接指定消息的长度

**注**：UDP协议通常不需要指定消息边界，因为UDP是数据报协议，应用程序从socket接收到的必定是发送方发送的完整消息。
## 2. Socket练习
### 2.1 机房监控问题
~~~json
我们现在要开发一个实验室的工作站监控系统，包括

1. 安装在机房工作站上的 数据采集器 RUS 这个程序作为TCP服务端，获取资源使用数据，简称 RUS （Resource Usage Stat）
2. 安装在监控室的管理控制台 AT 这个程序作为TCP客户端，向管理员显示资源使用数据，简称 AT （Admin Terminal）
你可以自行设计 RUS 和 AT 之间的数据传输规范，包括消息 数据格式规范。

下面是一种参考的规范：

AT 和 RUS 之间采用 TCP 长连接方式进行通讯
如果中途出现连接断开，AT 作为 TCP 客户端必须进行重连

消息整体
每个消息 都是 UTF8 编码的 字符串

由消息头 和消息体组成。

消息头 和消息体之间 用一个 换行符 （UTF8编码后的字节为 0A ）隔开。

有如下类型的消息：

控制命令

由 AT 发送给 RUS ， 下达管理控制命令。

比如：
pause 暂停数据采集
resume 恢复数据采集
RUS接收到 控制命令后，必须完成操作后必须回复响应消息，告诉 AT 命令已经接收已经完成

数据上报
由 RUS 发送给 AT，汇报采集的资源数据。 AT接收到数据后，应该回复一个接收汇报的响应消息。

消息头
消息头只包含一个信息： 消息体的长度 消息头用十进制的字符串 表示一个整数的长度

消息体
消息体用json格式的字符串 表示数据信息，如下

数据上报 RUS -> AT

{
    "type" : "report",
    "info" : {
        "CPU Usage" : "30%",
        "Mem usage" : "53%"
    }
}
数据上报响应 AT -> RUS

{
    "type" : "report-ack"
}
暂停数据上报命令 AT -> RUS

{
    "type" : "pause",
    "duration" :  200
}
其中 duration 表示暂停上报的时间，以秒为单位

恢复数据上报命令 AT -> RUS

{
    "type" : "resume"
}
命令处理响应 RUS -> AT

{
    "type" : "cmd-ack",
    "code" :  200,
    "info" : "处理成功"
}
其中code 是处理结果码，用200表示成功。 info 是处理结果文字描述。

~~~

### 2.2 多线程服务器

本项目实现了一个多线程代理服务器，它能够：

1. 接收客户端的HTTP请求。

2.  判断请求的文件是否已缓存。如果文件已缓存，则直接将缓存文件返回给客户端。

3. 如果文件未缓存，代理服务器会将请求转发给目标服务器并返回响应给客户端，同时缓存该响应以供后续使用。
4.  服务器能够同时处理多个客户端请求，得益于多线程技术，每个客户端请求由独立的线程处理，不会阻塞其他请求。